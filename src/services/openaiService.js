const { OpenAI } = require('openai');
require('dotenv').config();

class OpenAIService {
    constructor() {
        this.openai = new OpenAI({
            apiKey: process.env.OPENAI_API_KEY
        });
    }

    async generateResponse(name, message, messageHistory = []) {
        try {
            console.log('Gerando resposta para:', {
                name,
                message,
                historyLength: messageHistory.length
            });

            // Verifica se √© a primeira mensagem (sem hist√≥rico)
            const isFirstMessage = messageHistory.length === 1;

            const systemPrompt = isFirstMessage
                ? `Voc√™ √© Rita, uma assistente pessoal especializada em produtividade, gest√£o de tempo e bem estar. Esta √© a primeira intera√ß√£o com ${name}.
                
                Responda exatamente com esta mensagem (substituindo apenas o nome do usu√°rio):

                "Ol√° *${name}*! üëã 

                Sou *Rita*, sua assistente pessoal especializada em produtividade, gest√£o de tempo e bem estar! üéØ

                Posso te ajudar a:
                ‚Ä¢ Criar um plano di√°rio produtivo e equilibrado ‚è∞
                ‚Ä¢ Gerenciar melhor seu tempo com lembretes üì±
                ‚Ä¢ Acompanhar suas atividades e progresso üìù
                ‚Ä¢ Manter o equil√≠brio entre tarefas e bem estar ‚ú®

                Voc√™ tem *7 dias gratuitos* para experimentar. Quer come√ßar criando seu plano personalizado? Me conte um pouco sobre sua rotina! üí™"`
                : `Voc√™ √© Rita, uma assistente pessoal especializada em produtividade, gest√£o de tempo e bem estar.
                
                Mantenha suas respostas:
                ‚Ä¢ Curtas e objetivas
                ‚Ä¢ Focadas em organiza√ß√£o e rotina
                ‚Ä¢ Com no m√°ximo 2-3 linhas
                ‚Ä¢ Sempre direcionando para criar ou ajustar o plano
                
                Se o usu√°rio perguntar sobre hor√°rio, responda:
                "S√£o *HH:MM* (hor√°rio de Bras√≠lia). Posso te ajudar a organizar melhor seu tempo criando um plano personalizado! üòä"

                Se o usu√°rio perguntar o que voc√™ faz, responda:
                "Sou especializada em:
                ‚Ä¢ Criar planos di√°rios produtivos e equilibrados ‚è∞
                ‚Ä¢ Gerenciar seu tempo com lembretes inteligentes üì±
                ‚Ä¢ Acompanhar seu progresso e bem estar ‚ú®

                Quer come√ßar criando seu plano? üòä"`;

            // Check if user is asking for time
            if (message.toLowerCase().includes('que horas') || 
                message.toLowerCase().includes('hor√°rio') || 
                message.toLowerCase().includes('hora atual')) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'America/Sao_Paulo'
                });
                return `S√£o *${timeStr}* (hor√°rio de Bras√≠lia). Posso te ajudar a organizar melhor seu tempo criando um plano personalizado! üòä`;
            }

            const response = await this.openai.chat.completions.create({
                model: process.env.OPENAI_MODEL,
                messages: [
                    { role: "system", content: systemPrompt },
                    ...messageHistory,
                    { role: "user", content: message }
                ],
                temperature: 0.7
            });

            console.log('Resposta da OpenAI:', {
                status: 'sucesso',
                content: response.choices[0].message.content
            });

            return response.choices[0].message.content;
        } catch (error) {
            console.error('Erro ao gerar resposta:', error);
            throw error;
        }
    }

    async generateInitialPlan(name, message, messageHistory = []) {
        try {
            console.log('Gerando plano inicial para:', {
                name,
                message,
                historyLength: messageHistory.length
            });

            const response = await this.openai.chat.completions.create({
                model: process.env.OPENAI_MODEL,
                messages: [
                    {
                        role: "system",
                        content: `Voc√™ √© Rita, uma assistente pessoal especializada em produtividade, gest√£o de tempo e bem estar. Analise a rotina do usu√°rio e crie um plano personalizado que otimize sua produtividade e bem-estar.

                        Aspectos a considerar na an√°lise:
                        1. Ciclo de energia di√°rio:
                           - Hor√°rios de maior disposi√ß√£o
                           - Per√≠odos de baixa energia
                           - Necessidades de descanso

                        2. Gest√£o de tempo:
                           - Blocos de trabalho focado
                           - Pausas estrat√©gicas
                           - Transi√ß√µes entre atividades

                        3. H√°bitos e rotinas:
                           - Padr√µes atuais
                           - Oportunidades de melhoria
                           - Pontos de aten√ß√£o

                        4. Produtividade:
                           - T√©cnicas (Pomodoro, GTD, etc.)
                           - Elimina√ß√£o de distra√ß√µes
                           - Foco e concentra√ß√£o

                        5. Bem-estar:
                           - Equil√≠brio trabalho-vida
                           - Atividade f√≠sica
                           - Alimenta√ß√£o e hidrata√ß√£o

                        Para cada atividade, forne√ßa:
                        {
                            "atividades": [
                                {
                                    "hor√°rio": "HH:mm",
                                    "tarefa": "Descri√ß√£o da tarefa",
                                    "dura√ß√£o": n√∫mero_entre_5_e_240,
                                    "categoria": "trabalho|descanso|exerc√≠cio|alimenta√ß√£o|outros",
                                    "energia": "alta|m√©dia|baixa",
                                    "sugest√µes": ["Sugest√µes de melhoria ou otimiza√ß√£o"],
                                    "lembretes": {
                                        "antes": "Mensagem de prepara√ß√£o",
                                        "in√≠cio": "Mensagem motivacional",
                                        "durante": ["Dicas de foco/produtividade"],
                                        "final": "Mensagem de conclus√£o",
                                        "acompanhamento": "Reflex√£o/feedback"
                                    }
                                }
                            ],
                            "an√°lise": {
                                "pontos_fortes": ["Aspectos positivos da rotina"],
                                "oportunidades": ["Sugest√µes de melhoria"],
                                "perguntas": ["Quest√µes para entender melhor e otimizar"]
                            }
                        }

                        Regras importantes:
                        1. Hor√°rios e dura√ß√µes:
                           - Atividades entre 5-240 minutos
                           - N√£o divida atividades em partes
                           - Respeite hor√°rios fixos do usu√°rio
                           - Evite sobreposi√ß√µes de hor√°rios
                           
                        2. Pausas e descanso:
                           - 5-15 min a cada 90-120 min de trabalho
                           - Soneca p√≥s-almo√ßo m√°x. 30-40 min
                           - Intervalos para hidrata√ß√£o a cada 2-3h
                           
                        3. Hidrata√ß√£o distribu√≠da:
                           - √Ågua: 1,5L em 4-6 por√ß√µes
                           - Terer√©: 1,5L em 3-4 por√ß√µes
                           - Intercale √°gua e terer√©
                           
                        4. Estrutura do dia:
                           - Manh√£: atividades f√≠sicas/importantes
                           - Tarde: trabalho com pausas regulares
                           - Noite: atividades leves, prepara√ß√£o sono
                           
                        5. Sono e descanso:
                           - Hor√°rio dormir: 22:00-22:30
                           - Dura√ß√£o: 7-8 horas cont√≠nuas
                           - Prepara√ß√£o: 30-45 min antes
                           
                        6. Lembretes:
                           - Motivacionais e espec√≠ficos
                           - Use emojis relevantes
                           - Foque em produtividade e bem-estar`
                    },
                    ...messageHistory,
                    {
                        role: "user",
                        content: `Crie um plano para ${name} com base em: ${message}`
                    }
                ],
                temperature: 0.7,
                response_format: { type: "json_object" }
            });

            const plan = JSON.parse(response.choices[0].message.content);

            plan.atividades = plan.atividades.map(activity => {
                activity.dura√ß√£o = Math.max(5, activity.dura√ß√£o || 30);

                if (activity.dura√ß√£o > 240) {
                    const segments = [];
                    let remainingDuration = activity.dura√ß√£o;
                    let currentTime = activity.hor√°rio;

                    while (remainingDuration > 0) {
                        const segmentDuration = Math.min(remainingDuration, 240);
                        segments.push({
                            hor√°rio: currentTime,
                            tarefa: `${activity.tarefa} (Parte ${segments.length + 1})`,
                            dura√ß√£o: segmentDuration,
                            lembretes: {
                                antes: `‚è∞ Prepare-se para continuar _${activity.tarefa}_!`,
                                in√≠cio: `üöÄ Vamos focar em _${activity.tarefa}_!`,
                                durante: [`üí° Mantenha o foco em _${activity.tarefa}_.`],
                                final: remainingDuration <= 240
                                    ? `‚úÖ Voc√™ concluiu _${activity.tarefa}_!`
                                    : `‚è∏Ô∏è Hora de uma pausa de _${activity.tarefa}_!`,
                                acompanhamento: remainingDuration <= 240
                                    ? `üéâ Excelente trabalho em _${activity.tarefa}_!`
                                    : `üîã Recarregue as energias para continuar!`
                            }
                        });

                        remainingDuration -= segmentDuration;
                        const [hours, minutes] = currentTime.split(':').map(Number);
                        const nextTime = new Date(2024, 0, 1, hours, minutes + segmentDuration + 15);
                        currentTime = nextTime.toTimeString().slice(0, 5);
                    }
                    return segments;
                }

                return activity;
            });

            plan.atividades = plan.atividades.flat();

            console.log('Plano gerado:', {
                status: 'sucesso',
                atividades: plan.atividades.length
            });

            return plan;
        } catch (error) {
            console.error('Erro ao gerar plano inicial:', error);
            throw error;
        }
    }

    async generatePlanSummary(name, routine, messageHistory = []) {
        try {
            console.log('Gerando resumo do plano para:', {
                name,
                routine,
                historyLength: messageHistory.length
            });

            const response = await this.openai.chat.completions.create({
                model: process.env.OPENAI_MODEL,
                messages: [
                    {
                        role: "system",
                        content: `Voc√™ √© Rita, uma assistente pessoal especializada em produtividade, gest√£o de tempo e bem estar. 
                        
                        Resuma o plano di√°rio exatamente neste formato:

*üåÖ Manh√£ (at√© 12:00)*
‚Ä¢ *HH:MM* _Descri√ß√£o da atividade_

*üåû Tarde (12:00-18:00)*
‚Ä¢ *HH:MM* _Descri√ß√£o da atividade_

*üåô Noite (ap√≥s 18:00)*
‚Ä¢ *HH:MM* _Descri√ß√£o da atividade_

_Mensagem motivacional curta e relevante_ ‚ú®

Regras importantes:
1. Use formata√ß√£o consistente:
   - T√≠tulos: *emoji Per√≠odo (hor√°rio)*
   - Atividades: ‚Ä¢ *HH:MM* _Descri√ß√£o_
   - Mensagem final: _texto_ ‚ú®
2. Agrupe atividades por per√≠odo do dia
3. N√£o divida per√≠odos em subse√ß√µes
4. N√£o divida o sono em partes
5. Remova espa√ßos extras ap√≥s descri√ß√µes
6. Use apenas uma mensagem motivacional ao final
7. N√£o inclua per√≠odos sem atividades
8. Mantenha hor√°rios realistas e sem sobreposi√ß√µes
9. Respeite os hor√°rios fixos do usu√°rio (trabalho, compromissos)`
                    },
                    ...messageHistory,
                    {
                        role: "user",
                        content: `Resuma o plano de ${name}: ${JSON.stringify(routine)}`
                    }
                ],
                temperature: 0.7
            });

            console.log('Resumo gerado:', {
                status: 'sucesso',
                content: response.choices[0].message.content
            });

            return response.choices[0].message.content;
        } catch (error) {
            console.error('Erro ao gerar resumo do plano:', error);
            throw error;
        }
    }
}

module.exports = new OpenAIService();
